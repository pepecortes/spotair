-- create stored procedure
DROP PROCEDURE IF EXISTS CreateSearchTable;

DELIMITER //
CREATE PROCEDURE CreateSearchTable()
BEGIN
DROP TABLE IF EXISTS photoSearch;

CREATE TABLE photoSearch
SELECT photos.id, CONCAT_WS(', ', photos.commentaire,	photographes.nom,
	photographes.prenom, compagnies.nom, compagnies.flotille,
	appareils.immat, appareils.serial, appareils.commentaire,
	avions.version,	modeles.nom, modeles.surnom,	constructeurs.nom,
	galeries.commentaire,	annees.annee,	themes.theme,	aerodromes.nom,
	aerodromes.lieu) AS text
FROM photos
LEFT JOIN photographes ON photos.photographeId = photographes.id
LEFT JOIN compagnies ON photos.compagnieId = compagnies.id
LEFT JOIN appareils ON photos.appareilId = appareils.id
LEFT JOIN avions ON appareils.avionId = avions.id
LEFT JOIN modeles ON avions.modeleId = modeles.id
LEFT JOIN constructeurs ON modeles.constructeurId = constructeurs.id
LEFT JOIN galeries ON photos.galerieId = galeries.id
LEFT JOIN annees ON galeries.anneeId = annees.id
LEFT JOIN themes ON galeries.themeId = themes.id
LEFT JOIN aerodromes ON galeries.aerodromeId = aerodromes.id;

CREATE FULLTEXT INDEX fts ON photoSearch (text);
END //
DELIMITER ;

-- create event
DROP EVENT IF EXISTS CreateSearchTableEvent;
CREATE EVENT CreateSearchTableEvent
ON SCHEDULE EVERY 1 HOUR
ON COMPLETION PRESERVE
DO CALL CreateSearchTable;

-- How to call it?
CALL CreateSearchTable;

-- check EVEN SCHEDULER:
SHOW PROCESSLIST;

-- activate scheduler (caution: can be done in docker when starting mysql server)
SET GLOBAL event_scheduler = ON;

